# Badge Minter â€” Flow

This document outlines how we implement badge minting according to [NIP-58](https://github.com/nostr-protocol/nips/blob/master/58.md).

---

## Admin Flow

### 1. Nonce Generation

- Admin generates a **16-byte hex nonce**.
- Valid for a short duration (default: `120` seconds), configurable via environment:

  ```env
  NONCE_EXPIRATION_SECONDS=120
  ```

### 2. QR Code Composition

The QR encodes a Claim URL with:

- `nonce`: one-time-use hex string
- `t`: Expiration timestamp
- `naddr`: badge definition address

  - `kind`: `30009` (badge definition per NIP-58)
  - `identifier`: `BADGE_ID`
  - `pubkey`: `BADGE_AUTHOR_PUBKEY`

**Example:**

```
https://example.com/claim?nonce=abc123&naddr=naddr1q...xyz
```

### 3. QR Display

- Displayed on admin kiosk
- Refreshed every 15 seconds to avoid reuse

---

## User Flow

### 1. Scan & Resolve

- User scans the QR
- Enters Nostr address (NIP-05)
- Frontend resolves it to a Nostr `pubkey`

### 2. Generate Ephemeral Event

- A **disposable keypair** is created on the client
- Publish an ephemeral `kind: 25666` event:

```jsonc
{
  "pubkey": "DISPOSABLE_USER_PUBKEY",
  "kind": 25666,
  "tags": [
    ["p", "BADGE_AUTHOR_PUBKEY"],
    ["a", "30009:BADGE_AUTHOR_PUBKEY:BADGE_ID"],
    ["nonce", "NONCE"],
    ["t", "TIMESTAMP"]
  ],
  // JSON encoded
  "content": {
    "pubkey": "AWARDEE_PUBKEY",
    "nip05": "alice@example.com",
    "image": "https://avatar_image",
    "displayName": "Display Name"
  }
}
```

---

## Admin Listener

### 1. Subscription

Admin backend listens for:

- `kind: 25666`
- `#p = BADGE_AUTHOR_PUBKEY`

### 2. Validate Nonce

- Check that nonce:

  - Is not expired
  - Valid hash of `naddr`, `timestamp` and `salt`
  - Has not been used

### 3. Issue Badge

If valid, publish award event:

```jsonc
{
  "id": "AWARD_EVENT_ID",
  "pubkey": "BADGE_AUTHOR_PUBKEY",
  "kind": 8,
  "tags": [
    ["a", "30009:BADGE_AUTHOR_PUBKEY:BADGE_ID"],
    ["p", "AWARDEE_PUBKEY", "wss://relay"]
  ]
}
```

### 4. Respond to User

Send confirmation via ephemeral event:

```jsonc
{
  "pubkey": "BADGE_AUTHOR_PUBKEY",
  "kind": 25667,
  "tags": [
    ["p", "DISPOSABLE_USER_PUBKEY"],
    ["a", "30009:BADGE_AUTHOR_PUBKEY:BADGE_ID"],
    ["e", "AWARD_EVENT_ID"]
  ],
  "content": "{\"success\": true, \"error\": null}"
}
```

If failed:

```jsonc
{
  "content": "{\"success\": false, \"error\": \"Invalid or expired nonce\"}"
}
```

---

## Variable Reference

| Variable                 | Description                                                       |
| ------------------------ | ----------------------------------------------------------------- |
| `AWARD_EVENT_ID`         | ID of the award event (generated by signing the kind:8 event)     |
| `BADGE_AUTHOR_PUBKEY`    | Public key of the badge issuer                                    |
| `BADGE_ID`               | Badge definition identifier (aka `dtag`)                          |
| `DISPOSABLE_USER_PUBKEY` | Temporary public key generated on frontend for claiming the badge |
| `AWARDEE_PUBKEY`         | Badge award recipient's public key                                |

---
